---
title: "Age Differences in Functional Connectivity Metrics"
author: "Megan McMahon"
date: "5/23/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readr)
library(tidyverse)
library(reshape2)
library(corrplot)
library(beset)

load("~/Box/CogNeuroLab/Aging Decision Making R01/Data/combined_data_2019-12-24.RData")

cbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# load("~/Box/CogNeuroLab/Aging Decision Making R01/Data/combined_data_2019-12-13.RData")
# bct <- read_csv('~/Box/CogNeuroLab/Aging Decision Making R01/Analysis/rest/bct/bct_x.csv')
# d <- merge(d, bct, by = "record_id", all = TRUE)
# d$actquot <- d$actamp/d$actmesor
# d$Group <- factor(ifelse(d$record_id < 40000, 0, 1), labels = c("Young Adults", "Older Adults"))
# save(d, file = "~/Box/CogNeuroLab/Aging Decision Making R01/Data/combined_data_2019-12-24.RData")

ya_data <- d[d$Group == "Young Adults",]
oa_data <- d[d$Group == "Older Adults",]

```


# Comparing FC Metrics by Age Group 
**Whole brain**. Older adults have significantly higher participation coefficient, significantly lower global efficiency.
**DMN**. Older adults have lower efficiency and lower modularity within the default mode network.
**FPN**. Older adults have greater participation coefficient and betweeness centrality within the frontoparietal control network.

```{r}
d %>%
  select(Group, matches("wb_")) %>%
  na.omit() %>%
  melt(id.vars = "Group") %>%
  ggplot(aes(color = Group, group = Group)) + 
  geom_boxplot(aes(x = Group, y = value), size=1.2) + 
  facet_wrap( . ~ variable, scales = "free_y") +
  theme_classic() + 
  scale_colour_manual(values=c("blue", "red")) + 
  scale_x_discrete(labels = c("YA", "OA")) + 
  ggtitle("Whole Brain")

d %>%
  select(Group, matches("dmn_")) %>%
  na.omit() %>%
  melt(id.vars = "Group") %>%
  ggplot(aes(color = Group, group = Group)) + 
  geom_boxplot(aes(x = Group, y = value), size=1.2) + 
  facet_wrap( . ~ variable, scales = "free_y") +
  theme_classic() + 
  scale_colour_manual(values=c("blue", "red")) + 
  scale_x_discrete(labels = c("YA", "OA")) +
  ggtitle("Default Mode Network")

d %>%
  select(Group, matches("fpn_")) %>%
  na.omit() %>%
  melt(id.vars = "Group") %>%
  ggplot(aes(color = Group, group = Group)) + 
  geom_boxplot(aes(x = Group, y = value), size=1.2) + 
  facet_wrap( . ~ variable, scales = "free_y") +
  theme_classic() + 
  scale_colour_manual(values=c("blue", "red")) + 
  scale_x_discrete(labels = c("YA", "OA")) +
  ggtitle("Control Network")

t <- t.test(wb_participation_x ~ Group, data = d) ##
t
ggplot(d, aes(x = Group, y = wb_participation_x, color = Group)) +
  geom_boxplot() + 
  theme_classic() + 
  scale_colour_manual(values=c("blue", "red")) +
  scale_x_discrete(labels=c("YA", "OA")) + 
  xlab("Age Group") + ylab("Participation \n Coefficient") + 
  labs(caption = (paste("t = ", round(t$statistic, 3), "p = ", round(t$p.value, 3))))

t <- t.test(wb_efficiency_x ~ Group, data = d) ##
t
ggplot(d, aes(x = Group, y = wb_efficiency_x, color = Group)) +
  geom_boxplot(size = 1.2) + 
  theme_classic() + 
  scale_colour_manual(values=c("blue", "red")) +
  scale_x_discrete(labels=c("YA", "OA")) + 
  xlab("Age Group") + ylab("Global \n Efficiency") + 
  theme(axis.text=element_text(size=12), plot.caption = element_text(size = 12)) +
  labs(caption = (paste("t = ", round(t$statistic, 3), "p = ", round(t$p.value, 3))))

t <- t.test(dmn_efficiency_x ~ Group, data = d) ##
t
ggplot(d, aes(x = Group, y = dmn_efficiency_x, color = Group)) +
  geom_boxplot(size = 1.2) + 
  theme_classic() + 
  scale_colour_manual(values=c("blue", "red")) +
  scale_x_discrete(labels=c("YA", "OA")) + 
  xlab("Age Group") + ylab("Global \n Efficiency") + 
  theme(axis.text=element_text(size=12), plot.caption = element_text(size = 12)) +
  labs(caption = (paste("t = ", round(t$statistic, 3), "p = ", round(t$p.value, 3))))

t <- t.test(dmn_modularity_x ~ Group, data = d) ##
t
ggplot(d, aes(x = Group, y = dmn_modularity_x, color = Group)) +
  geom_boxplot(size = 1.2) + 
  theme_classic() + 
  scale_colour_manual(values=c("blue", "red")) +
  scale_x_discrete(labels=c("YA", "OA")) + 
  xlab("Age Group") + ylab("Global \n Efficiency") + 
  theme(axis.text=element_text(size=12), plot.caption = element_text(size = 12)) +
  labs(caption = (paste("t = ", round(t$statistic, 3), "p = ", round(t$p.value, 3))))

t <- t.test(fpn_participation_x ~ Group, data = d) ##
t
ggplot(d, aes(x = Group, y = fpn_participation_x, color = Group)) +
  geom_boxplot(size = 1.2) + 
  theme_classic() + 
  scale_colour_manual(values=c("blue", "red")) +
  scale_x_discrete(labels=c("YA", "OA")) + 
  xlab("Age Group") + ylab("Global \n Efficiency") + 
  theme(axis.text=element_text(size=12), plot.caption = element_text(size = 12)) +
  labs(caption = (paste("t = ", round(t$statistic, 3), "p = ", round(t$p.value, 3))))

t <- t.test(fpn_betweenness_x ~ Group, data = d) ##
t
ggplot(d, aes(x = Group, y = fpn_betweenness_x, color = Group)) +
  geom_boxplot(size = 1.2) + 
  theme_classic() + 
  scale_colour_manual(values=c("blue", "red")) +
  scale_x_discrete(labels=c("YA", "OA")) + 
  xlab("Age Group") + ylab("Global \n Efficiency") + 
  theme(axis.text=element_text(size=12), plot.caption = element_text(size = 12)) +
  labs(caption = (paste("t = ", round(t$statistic, 3), "p = ", round(t$p.value, 3))))
```


## Correlation Plots
```{r}
alpha = 0.05

oa_cor <- select(oa_data, age, IS:RA, actquot, actamp:fact, matches("wb_|dmn_|fpn_"), trails_b_z_score)
oa_cor <- oa_cor[complete.cases(oa_cor), ]
oa_mat <- cor(oa_cor)
oa_res <- cor.mtest(oa_mat, conf.level = (1-alpha))
corrplot(oa_mat, p.mat = oa_res$p, sig.level = alpha, insig = "blank", type = "upper")
```

```{r}
alpha = 0.05

ya_cor <- select(ya_data, age, IS:RA, actquot, actamp:fact, matches("wb_|dmn_|fpn_"), trails_b_z_score)
ya_cor <- ya_cor[complete.cases(ya_cor), ]
ya_mat <- cor(ya_cor)
ya_res <- cor.mtest(ya_mat, conf.level = (1-alpha))
corrplot(ya_mat, p.mat = ya_res$p, sig.level = alpha, insig = "blank", type = "upper")
```


## Rest-activity measure associations with Trails B performance
- **Older adults**. Lower CR minimum and later up-mesor predict greater TMT-B scores in older adults controlling for age
- **Young adults**. Greater duration of peak activity (lower width (alpha)) and greater rhythm robustness (F-statistic) predict higher TMT-B scores

```{r}
stepdata <- select(oa_data, age, actamp:fact, -rsqact, -actwidthratio, trails_b_z_score)
sum(complete.cases(stepdata))
mod <- beset_lm(trails_b_z_score ~ ., data = stepdata, n_folds = sum(complete.cases(stepdata)))
summary(mod, oneSE = FALSE, n_folds = sum(complete.cases(stepdata))) 
lm11 <- lm(trails_b_z_score ~ age + actmin + actupmesor, data = oa_data)
summary(lm11)
validate(lm11)
```

```{r}
stepdata <- select(ya_data, age, actamp:fact, -rsqact, -actwidthratio, trails_b_z_score)
sum(complete.cases(stepdata))
mod <- beset_lm(trails_b_z_score ~ ., data = stepdata, n_folds = sum(complete.cases(stepdata)))
summary(mod, oneSE = FALSE, n_folds = sum(complete.cases(stepdata))) 
lm01 <- lm(trails_b_z_score ~ actalph + fact, data = ya_data)
summary(lm01)
validate(lm01)
```

## Rest-activity measure associations with participation coefficient
Participation coefficient is a measure of integration. It describes how much a given node "participates" in networks outside of its own.

- Greater rhythm robustness (F-statistic) related to greater mean participation coefficient at the whole brain level in older adults
```{r}
summary(lm(trails_b_z_score ~ fpn_participation_x*Group, data = d))

d %>%
  filter(trails_b_z_score >= -2) %>%
  ggplot(aes(group = Group, color = Group)) +
  geom_point(aes(x = fpn_participation_x, y = trails_b_z_score, group = Group, color = Group)) +
  stat_smooth(aes(x = fpn_participation_x, y = trails_b_z_score, group = Group, color= Group), method = "lm") +
  theme_classic() +
  scale_color_manual(values = c("blue", "red")) +
  xlab("FPN Participation Coefficient") + ylab("TMT-B z-score") 

```


```{r}
alpha = 0.05

oa_cor <- select(oa_data, age, matches("wb_|dmn_|fpn_"), matches("zscore|z_score"))
oa_cor <- oa_cor[complete.cases(oa_cor), ]
oa_mat <- cor(oa_cor)
oa_res <- cor.mtest(oa_mat, conf.level = (1-alpha))
corrplot(oa_mat, p.mat = oa_res$p, sig.level = alpha, insig = "blank", type = "upper")
```


```{r}
summary(lm(cvlt_zscore ~ fpn_participation_x, oa_data)) #NS
d %>%
  ggplot(aes(group = Group, color = Group)) +
  geom_point(aes(x = fpn_participation_x, y = cvlt_zscore, group = Group, color = Group)) +
  stat_smooth(aes(x = fpn_participation_x, y = cvlt_zscore, group = Group, color= Group), method = "lm") +
  theme_classic() +
  scale_color_manual(values = c("blue", "red")) +
  xlab("FPN Participation Coefficient") + ylab("CVLT z-score") 
```


## Participation
```{r}
alpha = 0.05

oa_cor <- select(oa_data, age, IS:RA, actquot, actamp:fact, matches("participation"))
oa_cor <- oa_cor[complete.cases(oa_cor), ]
oa_mat <- cor(oa_cor)
oa_res <- cor.mtest(oa_mat, conf.level = (1-alpha))
corrplot(oa_mat, p.mat = oa_res$p, sig.level = alpha, insig = "blank", type = "upper")


oa_cor <- select(oa_data, age, matches("participation"), matches("zscore|z_score"))
oa_cor <- oa_cor[complete.cases(oa_cor), ]
oa_mat <- cor(oa_cor)
oa_res <- cor.mtest(oa_mat, conf.level = (1-alpha))
corrplot(oa_mat, p.mat = oa_res$p, sig.level = alpha, insig = "blank", type = "upper")
```


```{r}
d %>%
  ggplot(aes(group = Group, color = Group)) +
  geom_point(aes(x = dmn_participation_x, y =vc_zscore, group = Group, color = Group)) +
  stat_smooth(aes(x = dmn_participation_x, y = vc_zscore, group = Group, color= Group), method = "lm") +
  theme_classic() +
  scale_color_manual(values = c("blue", "red")) +
  xlab("DMN Participation Coefficient") + ylab("Vocabulary z-score") 
```


## Global Efficiency
```{r}
alpha = 0.05

oa_cor <- select(oa_data, age, IS:RA, actquot, actamp:fact, matches("efficiency"))
oa_cor <- oa_cor[complete.cases(oa_cor), ]
oa_mat <- cor(oa_cor)
oa_res <- cor.mtest(oa_mat, conf.level = (1-alpha))
corrplot(oa_mat, p.mat = oa_res$p, sig.level = alpha, insig = "blank", type = "upper")


oa_cor <- select(oa_data, age, matches("efficiency"), matches("zscore|z_score"))
oa_cor <- oa_cor[complete.cases(oa_cor), ]
oa_mat <- cor(oa_cor)
oa_res <- cor.mtest(oa_mat, conf.level = (1-alpha))
corrplot(oa_mat, p.mat = oa_res$p, sig.level = alpha, insig = "blank", type = "upper")
```

